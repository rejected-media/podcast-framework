---
/**
 * Base Layout
 *
 * Main layout with SEO, analytics, theme, and common components (Header/Footer)
 *
 * ⚠️ IMPORTANT: Do NOT import this layout directly in your pages!
 *
 * This framework layout does not include your project's CSS (global.css, Tailwind, etc.).
 * Instead, import your project's local BaseLayout wrapper which imports CSS:
 *
 * @layout
 * @example Correct usage (import from your project):
 * ```astro
 * ---
 * import BaseLayout from '../layouts/BaseLayout.astro';  // ← Your local wrapper
 * ---
 *
 * <BaseLayout title="Page Title" description="Description">
 *   <h1>Page Content</h1>
 * </BaseLayout>
 * ```
 *
 * @example Your local wrapper should look like:
 * ```astro
 * ---
 * import FrameworkBaseLayout from '@rejected-media/podcast-framework-core/layouts/BaseLayout.astro';
 * import '../styles/global.css';  // ← Imports your CSS
 *
 * const props = Astro.props;
 * ---
 * <FrameworkBaseLayout {...props}>
 *   <slot />
 * </FrameworkBaseLayout>
 * ```
 *
 * This wrapper pattern allows the framework to remain CSS-agnostic while
 * giving you full control over styling (Tailwind, vanilla CSS, etc.).
 */

import type { Theme, PodcastInfo } from '../lib/types';
import { defaultTheme, generateThemeCSS, getGoogleFontsURL } from '../lib/theme';
import { getComponent } from '../lib/component-resolver';

// Import framework Header/Footer (will be auto-resolved for overrides)
const Header = getComponent('Header');
const Footer = getComponent('Footer');

export interface Props {
  title: string;
  description: string;
  ogImage?: string;
  podcastInfo?: PodcastInfo;
  theme?: Theme;
  gaId?: string;
  structuredData?: Record<string, any>;
}

const {
  title,
  description,
  ogImage: propOgImage,
  podcastInfo,
  theme: propTheme,
  gaId,
  structuredData
} = Astro.props;

// Handle null theme explicitly (use defaultTheme if theme is null or undefined)
const theme = propTheme || defaultTheme;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Default OG image fallback (simple data URI with podcast branding)
// This ensures OG tags always have a valid image even if no custom image is set
const DEFAULT_OG_IMAGE = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630' viewBox='0 0 1200 630'%3E%3Crect fill='%2300a3b5' width='1200' height='630'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='system-ui,-apple-system,sans-serif' font-size='96' font-weight='bold' fill='white'%3EPodcast%3C/text%3E%3C/svg%3E`;
const ogImage = propOgImage || podcastInfo?.logo?.url || DEFAULT_OG_IMAGE;

// Favicon from Sanity CMS or fallback to static files
const faviconUrl = podcastInfo?.favicon?.url || '/favicon.svg';
const faviconPngUrl = '/favicon.png';
const themeCSS = generateThemeCSS(theme);
const googleFontsUrl = theme.typography.fontFamily?.includes('Google:')
  ? getGoogleFontsURL([theme.typography.fontFamily])
  : '';

// Google Analytics from environment or props
const GA_MEASUREMENT_ID = gaId || import.meta.env.PUBLIC_GA_MEASUREMENT_ID;

// Prepare Header props
const siteName = podcastInfo?.name || 'Podcast';
const siteTagline = podcastInfo?.tagline;
const logoUrl = podcastInfo?.logo?.url;
const showContribute = podcastInfo?.isActive === true;

// Navigation items
const navigation = [
  { href: '/', label: 'Home' },
  { href: '/episodes', label: 'Episodes' },
  { href: '/guests', label: 'Guests' },
  { href: '/contribute', label: 'Contribute', show: showContribute },
  { href: '/about', label: 'About' }
];

// Footer social links (support both appleUrl and applePodcastsUrl for backwards compatibility)
const appleLink = podcastInfo?.appleUrl || podcastInfo?.applePodcastsUrl;
const twitterLink = podcastInfo?.twitterUrl || (podcastInfo?.twitterHandle ? `https://twitter.com/${podcastInfo.twitterHandle}` : null);
const socialLinks = [
  podcastInfo?.spotifyUrl && { href: podcastInfo.spotifyUrl, label: 'Spotify' },
  appleLink && { href: appleLink, label: 'Apple Podcasts' },
  podcastInfo?.youtubeUrl && { href: podcastInfo.youtubeUrl, label: 'YouTube' },
  podcastInfo?.rssUrl && { href: podcastInfo.rssUrl, label: 'RSS Feed' },
  twitterLink && { href: twitterLink, label: 'Twitter/X' }
].filter(Boolean) as Array<{ href: string; label: string }>;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href={faviconUrl} />
    <link rel="alternate icon" type="image/png" href={faviconPngUrl} />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com; frame-src 'self' https://open.spotify.com https://www.youtube.com; object-src 'none';" />

    <!-- Google Fonts -->
    {googleFontsUrl && <link rel="preconnect" href="https://fonts.googleapis.com" />}
    {googleFontsUrl && <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />}
    {googleFontsUrl && <link href={googleFontsUrl} rel="stylesheet" />}

    <!-- Theme CSS Variables -->
    <style is:inline set:html={themeCSS}></style>

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, Astro.site)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(ogImage, Astro.site)} />
    {podcastInfo?.twitterHandle && (
      <meta property="twitter:site" content={`@${podcastInfo.twitterHandle}`} />
    )}
    {podcastInfo?.twitterHandle && (
      <meta property="twitter:creator" content={`@${podcastInfo.twitterHandle}`} />
    )}

    <!-- Google Analytics 4 -->
    {GA_MEASUREMENT_ID && (
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}></script>
    )}
    {GA_MEASUREMENT_ID && (
      <script is:inline define:vars={{ GA_MEASUREMENT_ID }}>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', GA_MEASUREMENT_ID);
      </script>
    )}

    <!-- Structured Data (JSON-LD) -->
    {structuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    )}

    <!-- Additional head content slot -->
    <slot name="head" />
  </head>

  <body class="bg-gray-50 text-gray-900 flex flex-col min-h-screen">
    <!-- Allow header override via slot -->
    <slot name="header">
      <Header
        siteName={siteName}
        siteTagline={siteTagline}
        logoUrl={logoUrl}
        navigation={navigation}
        theme={theme}
      />
    </slot>

    <!-- Main content -->
    <slot />

    <!-- Allow footer override via slot -->
    <slot name="footer">
      <Footer
        siteName={siteName}
        siteDescription={podcastInfo?.description}
        navigation={navigation}
        socialLinks={socialLinks}
        theme={theme}
        showNewsletter={podcastInfo?.isActive && podcastInfo?.newsletterEnabled}
      />
    </slot>
  </body>
</html>
